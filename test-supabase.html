<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Supabase - Cat√°logo FYL</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        button {
            background: #CD844D;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #b8733a; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üß™ Test de Conexi√≥n Supabase - Cat√°logo FYL</h1>
    
    <div class="test-container">
        <h2>üìã Configuraci√≥n Actual</h2>
        <div id="config-info">Cargando...</div>
    </div>

    <div class="test-container">
        <h2>üóÑÔ∏è Test de Conexi√≥n Supabase</h2>
        <button onclick="testSupabaseConnection()">Probar Conexi√≥n</button>
        <div id="connection-result">Haz clic en "Probar Conexi√≥n"</div>
    </div>

    <div class="test-container">
        <h2>üìä Test de Carga de Datos</h2>
        <button onclick="testDataLoading()">Cargar Productos</button>
        <div id="data-result">Haz clic en "Cargar Productos"</div>
    </div>

    <div class="test-container">
        <h2>üîß Test de Google Sheets (Fallback)</h2>
        <button onclick="testGoogleSheets()">Probar Google Sheets</button>
        <div id="sheets-result">Haz clic en "Probar Google Sheets"</div>
    </div>

    <div class="test-container">
        <h2>üìù Instrucciones</h2>
        <ol>
            <li>Si no tienes <code>config.local.js</code>, cr√©alo bas√°ndote en <code>config.local.example.js</code></li>
            <li>Configura tu clave de Supabase en <code>config.local.js</code></li>
            <li>Ejecuta los tests para verificar la conexi√≥n</li>
            <li>Si Supabase funciona, los productos se cargar√°n desde ah√≠</li>
            <li>Si Supabase falla, se usar√° Google Sheets autom√°ticamente</li>
        </ol>
    </div>

    <script type="module">
        // Cargar configuraci√≥n
        let config = {
            SUPABASE_URL: "No configurado",
            SUPABASE_ANON_KEY: "No configurado",
            USE_SUPABASE: false,
            USE_OPEN_SHEET_FALLBACK: true
        };

        // Intentar cargar configuraci√≥n local
        try {
            const localConfig = await import('./scripts/config.local.js');
            config = {
                SUPABASE_URL: localConfig.SUPABASE_URL || "No configurado",
                SUPABASE_ANON_KEY: localConfig.SUPABASE_ANON_KEY ? "Configurada" : "No configurada",
                USE_SUPABASE: localConfig.USE_SUPABASE || false,
                USE_OPEN_SHEET_FALLBACK: localConfig.USE_OPEN_SHEET_FALLBACK || true
            };
        } catch (e) {
            console.warn("No se pudo cargar config.local.js:", e.message);
        }

        // Mostrar configuraci√≥n
        document.getElementById('config-info').innerHTML = `
            <p><strong>SUPABASE_URL:</strong> <span class="${config.SUPABASE_URL.includes('supabase.co') ? 'success' : 'error'}">${config.SUPABASE_URL}</span></p>
            <p><strong>SUPABASE_ANON_KEY:</strong> <span class="${config.SUPABASE_ANON_KEY === 'Configurada' ? 'success' : 'error'}">${config.SUPABASE_ANON_KEY}</span></p>
            <p><strong>USE_SUPABASE:</strong> <span class="${config.USE_SUPABASE ? 'success' : 'warning'}">${config.USE_SUPABASE}</span></p>
            <p><strong>USE_OPEN_SHEET_FALLBACK:</strong> <span class="${config.USE_OPEN_SHEET_FALLBACK ? 'success' : 'warning'}">${config.USE_OPEN_SHEET_FALLBACK}</span></p>
        `;

        // Cliente de Supabase
        let supabase = null;

        // Inicializar Supabase
        async function initSupabase() {
            if (!config.SUPABASE_URL || !config.SUPABASE_ANON_KEY || config.SUPABASE_ANON_KEY === "No configurada") {
                throw new Error("Configuraci√≥n de Supabase incompleta");
            }

            try {
                const { createClient } = await import('https://cdn.skypack.dev/@supabase/supabase-js@2');
                supabase = createClient(config.SUPABASE_URL, config.SUPABASE_ANON_KEY);
                return true;
            } catch (error) {
                throw new Error(`Error creando cliente: ${error.message}`);
            }
        }

        // Test de conexi√≥n Supabase
        window.testSupabaseConnection = async function() {
            const resultDiv = document.getElementById('connection-result');
            resultDiv.innerHTML = '<p class="info">üîÑ Probando conexi√≥n...</p>';

            try {
                await initSupabase();
                
                // Probar una consulta simple
                const { data, error } = await supabase
                    .from('catalog_public_view')
                    .select('count')
                    .limit(1);

                if (error) {
                    throw new Error(`Error de Supabase: ${error.message}`);
                }

                resultDiv.innerHTML = `
                    <p class="success">‚úÖ Conexi√≥n exitosa a Supabase</p>
                    <p class="info">üìä Datos disponibles: ${data !== null ? 'S√≠' : 'No'}</p>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <p class="error">‚ùå Error de conexi√≥n: ${error.message}</p>
                    <p class="warning">üí° Verifica tu configuraci√≥n en config.local.js</p>
                `;
            }
        };

        // Test de carga de datos
        window.testDataLoading = async function() {
            const resultDiv = document.getElementById('data-result');
            resultDiv.innerHTML = '<p class="info">üîÑ Cargando datos...</p>';

            try {
                if (!supabase) {
                    await initSupabase();
                }

                // Cargar algunos productos
                const { data, error } = await supabase
                    .from('catalog_public_view')
                    .select('*')
                    .limit(5);

                if (error) {
                    throw new Error(`Error cargando datos: ${error.message}`);
                }

                resultDiv.innerHTML = `
                    <p class="success">‚úÖ Datos cargados exitosamente</p>
                    <p class="info">üìä Productos encontrados: ${data.length}</p>
                    <details>
                        <summary>Ver datos de muestra</summary>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </details>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <p class="error">‚ùå Error cargando datos: ${error.message}</p>
                    <p class="warning">üí° Verifica que la tabla 'catalog_public_view' exista y tenga datos</p>
                `;
            }
        };

        // Test de Google Sheets
        window.testGoogleSheets = async function() {
            const resultDiv = document.getElementById('sheets-result');
            resultDiv.innerHTML = '<p class="info">üîÑ Probando Google Sheets...</p>';

            try {
                const response = await fetch('https://opensheet.elk.sh/1kdhxSWHl3Rg0tXpaRsKhR_m30oTZhzqYj5ypsjtcTig/Calzado');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                resultDiv.innerHTML = `
                    <p class="success">‚úÖ Google Sheets accesible</p>
                    <p class="info">üìä Productos encontrados: ${data.length}</p>
                    <details>
                        <summary>Ver datos de muestra</summary>
                        <pre>${JSON.stringify(data.slice(0, 2), null, 2)}</pre>
                    </details>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <p class="error">‚ùå Error accediendo a Google Sheets: ${error.message}</p>
                    <p class="warning">üí° Verifica tu conexi√≥n a internet</p>
                `;
            }
        };
    </script>
</body>
</html>

